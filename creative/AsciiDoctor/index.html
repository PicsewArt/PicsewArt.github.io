<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>AsciiDoctor.js</title>
		
		<style type="text/css">
			.editor,
			.previewer {
				display: inline;
				float: left;
				width: calc(50% - 20px);
				height: 100%;
			}
			.editor {
/*				background-color: #ffd43b;*/
				height: calc(100vh - 20px);
			}
			.previewer {
				padding: 10px;
/*				background-color: #ff00ff;*/
				height: calc(100vh - 20px);
/*				overflow: scroll;*/
			}
			.css {
				display: none;
			}
		</style>
		
		<script src="node_modules/@asciidoctor/core/dist/browser/asciidoctor.js"></script>
		<script type="text/javascript">
		</script>
	</head>
	<body>
		<input type='file' onchange='loadFile(this)'>
		<input type='file' accept='text/css' onchange='loadCss(this)'>
		<button type="button" onclick="previewDoc()">Preview</button> 
		<button type="button" onclick="saveFile()">Save</button> 
		<textarea class="editor" id="editor"></textarea>
		<div class="previewer" id="previewer">
			<iframe id="iframe" width="100%" height="100%" frameborder="0"></iframe>
		</div>
		<textarea class="css" id="css"></textarea>
	</body>
	<script type="text/javascript">
		function previewDoc() {
			var asciidoctor = Asciidoctor()
			var content = document.getElementById("editor").value ?? '';
			var doctitle = 'Test';
			var html = asciidoctor.convert(content, { 'standalone': true, 'attributes': { 'showtitle': true, 'icons': 'font'} });
//			var css = 'golo';
//			var css = 'colony';
//			var css = 'asciidoctor';
			var css = document.getElementById('css').value ?? '';
			var template = '<!DOCTYPE html>' +
			'<html>' +
			'<head>' +
			'<meta charset="UTF-8">' +
//			'<meta name="content-disposition" content="inline; filename=preview.html">' +
			'<title>' + doctitle + '</title>' +
//			'<link href="./css/' + css + '.css" rel="stylesheet" type="text/css">' + 
			'<style type="text/css">' +
			css +
			'</style>' +
			'</head>' +
			'<body>' +
			html
			'</body>' +
			'</html>'
			var iframe = document.getElementById('iframe');
			iframe.srcdoc = template;
		};
		function loadFile(input) {  
			//支持chrome IE10  
			if (window.FileReader) {  
				var file = input.files[0];  
				filename = file.name.split(".")[0];  
				var reader = new FileReader();  
				reader.onload = function() {  
					document.getElementById('editor').value = this.result;
				}  
				reader.readAsText(file);  
			}   
			//支持IE 7 8 9 10  
			else if (typeof window.ActiveXObject != 'undefined'){  
				var xmlDoc;   
				xmlDoc = new ActiveXObject("Microsoft.XMLDOM");   
				xmlDoc.async = false;   
				xmlDoc.load(input.value);   
				document.getElementById('editor').value = xmlDoc.xml;
			}   
			//支持FF  
			else if (document.implementation && document.implementation.createDocument) {   
				var xmlDoc;   
				xmlDoc = document.implementation.createDocument("", "", null);   
				xmlDoc.async = false;   
				xmlDoc.load(input.value);   
				document.getElementById('editor').value = xmlDoc.xml;
			} else {   
				alert('error');   
			}
		};
		function loadCss(input) {  
			//支持chrome IE10  
			if (window.FileReader) {  
				var file = input.files[0];  
				filename = file.name.split(".")[0];  
				var reader = new FileReader();  
				reader.onload = function() {  
					document.getElementById('css').value = this.result;
				}  
				reader.readAsText(file);  
			}   
			//支持IE 7 8 9 10  
			else if (typeof window.ActiveXObject != 'undefined'){  
				var xmlDoc;   
				xmlDoc = new ActiveXObject("Microsoft.XMLDOM");   
				xmlDoc.async = false;   
				xmlDoc.load(input.value);   
				document.getElementById('css').value = xmlDoc.xml;
			}   
			//支持FF  
			else if (document.implementation && document.implementation.createDocument) {   
				var xmlDoc;   
				xmlDoc = document.implementation.createDocument("", "", null);   
				xmlDoc.async = false;   
				xmlDoc.load(input.value);   
				document.getElementById('css').value = xmlDoc.xml;
			} else {   
				alert('error');   
			}
		};
		function saveFile() {
			var iframe = document.getElementById('iframe');
			var elementA = document.createElement('a');
			elementA.setAttribute('href', 'data:text/html;charset=utf-8,' + encodeURIComponent(iframe.srcdoc));
			elementA.setAttribute('download', +new Date() + ".html");
			elementA.style.display = 'none';
			document.body.appendChild(elementA);
			elementA.click();
			document.body.removeChild(elementA);
		};
	</script>
</html>